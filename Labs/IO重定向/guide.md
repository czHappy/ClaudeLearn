# I/O 重定向实验指导书

## 实验目标

掌握 C++ 中的输入输出重定向技术，包括文件流操作、格式化输出、流状态检测等核心知识点。

## 知识点清单

### 1. 标准输入输出流
- `cin` - 标准输入流
- `cout` - 标准输出流
- `cerr` - 标准错误流（无缓冲）
- `clog` - 标准日志流（有缓冲）

### 2. 文件流类
```cpp
#include <fstream>

ifstream  // 输入文件流（读取）
ofstream  // 输出文件流（写入）
fstream   // 读写文件流
```

### 3. 文件打开模式
| 模式 | 说明 |
|------|------|
| `ios::in` | 读模式打开 |
| `ios::out` | 写模式打开（覆盖） |
| `ios::app` | 追加模式（文件末尾） |
| `ios::ate` | 打开后定位到文件末尾 |
| `ios::trunc` | 打开时清空文件 |
| `ios::binary` | 二进制模式 |

模式可以组合使用：
```cpp
fstream file("data.txt", ios::in | ios::out | ios::app);
```

### 4. 流状态检测
```cpp
file.eof()   // 是否到达文件末尾
file.fail()  // 读写操作是否失败
file.bad()   // 是否发生严重错误
file.good()  // 流是否正常
file.clear() // 清除错误标志
```

### 5. 格式化输出（需要 `#include <iomanip>`）
```cpp
setw(n)           // 设置字段宽度
setprecision(n)   // 设置浮点数精度
fixed             // 固定小数点格式
left/right        // 左对齐/右对齐
setfill(c)        // 设置填充字符
```

### 6. 字符串输入
```cpp
// 读取一行（包含空格）
string line;
getline(cin, line);
getline(file, line);

// 读取单词（遇空格停止）
string word;
cin >> word;
file >> word;
```

### 7. 二进制文件操作
```cpp
// 写入
file.write(reinterpret_cast<char*>(&obj), sizeof(obj));

// 读取
file.read(reinterpret_cast<char*>(&obj), sizeof(obj));
```

### 8. 字符串流（需要 `#include <sstream>`）
```cpp
stringstream ss;
ss << "123 456";
int a, b;
ss >> a >> b;  // 解析字符串
```

## 实验背景

实现一个学生成绩文件管理系统，支持成绩的保存、加载、追加和格式化输出。

### 学生信息结构
```cpp
struct Student {
    int id;              // 学号
    char name[20];       // 姓名
    double score;        // 成绩
};
```

## 实验任务

### 任务 1：文本文件写入
**目标**：将学生成绩保存到文本文件

**要求**：
- 使用 `ofstream` 打开文件
- 检查文件是否成功打开
- 按行写入学生信息（格式：学号 姓名 成绩）
- 正确关闭文件

**示例输出（scores.txt）**：
```
1001 张三 95.5
1002 李四 87.0
1003 王五 92.5
```

### 任务 2：文本文件读取
**目标**：从文本文件加载学生成绩

**要求**：
- 使用 `ifstream` 打开文件
- 检查文件是否存在
- 逐行读取数据到结构体数组
- 使用 `eof()` 检测文件末尾
- 输出读取的记录数

### 任务 3：追加模式写入
**目标**：向现有文件追加新的学生记录

**要求**：
- 使用 `ios::app` 模式打开文件
- 追加新记录，不覆盖原有数据
- 验证追加成功

**提示**：
```cpp
ofstream file("scores.txt", ios::app);
```

### 任务 4：格式化输出
**目标**：以美观的表格形式输出成绩单

**要求**：
- 使用 `setw()` 设置列宽
- 使用 `left/right` 设置对齐方式
- 使用 `fixed` 和 `setprecision(1)` 格式化浮点数
- 输出表头和分隔线

**期望输出**：
```
====================================
学号      姓名        成绩
====================================
1001      张三        95.5
1002      李四        87.0
1003      王五        92.5
====================================
```

### 任务 5：流状态检测
**目标**：实现健壮的文件操作错误处理

**要求**：
- 检测文件打开失败
- 检测读取错误
- 使用 `fail()` 和 `bad()` 判断错误类型
- 提供友好的错误提示

**示例**：
```cpp
if (!file.is_open()) {
    cerr << "错误：无法打开文件" << endl;
    return;
}

if (file.fail()) {
    cerr << "错误：读取失败" << endl;
}
```

### 任务 6：二进制文件操作
**目标**：使用二进制模式读写结构体

**要求**：
- 使用 `ios::binary` 模式
- 使用 `write()` 和 `read()` 函数
- 正确处理结构体指针转换
- 比较文本模式和二进制模式的区别

**写入示例**：
```cpp
ofstream file("students.dat", ios::binary);
Student s = {1001, "张三", 95.5};
file.write(reinterpret_cast<char*>(&s), sizeof(Student));
```

**读取示例**：
```cpp
ifstream file("students.dat", ios::binary);
Student s;
file.read(reinterpret_cast<char*>(&s), sizeof(Student));
```

### 任务 7：字符串流解析
**目标**：使用 `stringstream` 解析复杂字符串

**要求**：
- 解析 CSV 格式的成绩数据
- 处理包含多个字段的输入
- 实现字符串到数值的转换

**示例**：
```cpp
string line = "1001,张三,95.5";
stringstream ss(line);
int id;
string name;
double score;
char comma;
ss >> id >> comma >> name >> comma >> score;
```

### 任务 8：综合应用 - 完整成绩管理系统
**目标**：整合所有知识点，实现完整的文件管理功能

**功能要求**：
1. 添加学生成绩（追加到文件）
2. 显示所有成绩（格式化输出）
3. 查找学生（按学号）
4. 保存为二进制文件
5. 从二进制文件加载
6. 导出为 CSV 格式
7. 统计平均分

**菜单示例**：
```
===== 学生成绩管理系统 =====
1. 添加学生成绩
2. 显示所有成绩
3. 查找学生
4. 保存为二进制文件
5. 从二进制文件加载
6. 导出为CSV
7. 统计平均分
0. 退出
请选择：
```

## 实验步骤

### 第一步：环境准备
1. 创建项目文件夹
2. 包含必要的头文件：
   ```cpp
   #include <iostream>
   #include <fstream>
   #include <iomanip>
   #include <sstream>
   #include <vector>
   #include <string>
   ```

### 第二步：定义数据结构
```cpp
struct Student {
    int id;
    char name[20];
    double score;
};
```

### 第三步：实现各个任务函数
按照任务 1-8 的顺序逐个实现。

### 第四步：测试验证
- 测试文件的创建和读取
- 验证追加模式
- 检查格式化输出效果
- 测试错误处理
- 比较文本和二进制文件

## 常见错误与解决

### 错误 1：文件打开失败
**原因**：路径错误、权限不足、文件不存在
**解决**：
```cpp
if (!file.is_open()) {
    cerr << "文件打开失败！" << endl;
    return;
}
```

### 错误 2：读取数据格式错误
**原因**：文件格式与读取格式不匹配
**解决**：使用 `getline()` 读取整行后再解析

### 错误 3：中文乱码
**原因**：编码不一致
**解决**：使用 `char` 数组存储中文，或使用宽字符流

### 错误 4：二进制文件读取错误
**原因**：未使用 `ios::binary` 模式
**解决**：确保读写都使用二进制模式

### 错误 5：追加模式覆盖了文件
**原因**：使用了 `ios::out` 而非 `ios::app`
**解决**：明确使用追加模式

## 进阶挑战

1. 实现成绩排序功能（按分数降序）
2. 支持批量导入（从 CSV 文件）
3. 实现数据备份功能
4. 添加数据加密（简单异或加密）
5. 实现文件压缩（去除重复记录）

## 评分标准

| 任务 | 分值 | 要求 |
|------|------|------|
| 任务 1 | 10 | 正确实现文本文件写入 |
| 任务 2 | 10 | 正确实现文本文件读取 |
| 任务 3 | 10 | 正确实现追加模式 |
| 任务 4 | 15 | 格式化输出美观 |
| 任务 5 | 10 | 完善的错误处理 |
| 任务 6 | 15 | 正确的二进制操作 |
| 任务 7 | 10 | 字符串流解析 |
| 任务 8 | 20 | 综合应用功能完整 |

## 提交要求

1. 提交完整的 `.cpp` 源代码
2. 提交测试用的数据文件
3. 提交实验报告（包含运行截图）
4. 代码规范，注释清晰

## 参考资料

- C++ Primer（第5版）- 第8章 IO库
- cppreference.com - Input/output library
- 《C++ 标准库》- 文件流章节

## 实验时间

建议用时：3-4 小时

## 注意事项

1. 文件操作后要关闭文件（或使用 RAII）
2. 二进制模式和文本模式不能混用
3. Windows 和 Linux 的换行符不同（\r\n vs \n）
4. 处理中文时注意编码问题
5. 使用 `vector` 存储动态数量的学生数据

祝实验顺利！
